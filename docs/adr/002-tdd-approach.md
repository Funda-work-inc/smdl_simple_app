# ADR-002: TDD（テスト駆動開発）の採用

## ステータス

**承認済み** (2025-12-25)

## コンテキスト

SMDL簡易版ウェブアプリの開発手法を決定する必要があった。特に、品質保証とコードの保守性を高めるために、開発プロセスにおけるテストの位置づけを明確にする必要があった。

### 要件

- コードの品質を保証すること
- リファクタリングを安全に行えること
- 将来的な機能追加・変更に対応しやすいこと
- ドキュメントとしても機能すること

### 検討時の制約

- 開発・学習用プロジェクトのため、学習効果を最大化したい
- 初期の開発速度よりも、長期的な保守性を重視
- チームメンバーがTDDに不慣れであるが、習得する意欲がある

## 決定

**TDD（Test-Driven Development）** を開発手法として採用する。

### 開発フロー

```
Red（テスト作成）→ Green（実装）→ Refactor（リファクタリング）
```

1. **Red**: 先にテストを書き、失敗することを確認
2. **Green**: テストが通る最小限の実装を行う
3. **Refactor**: コードをきれいにリファクタリング

### 採用理由

1. **品質の向上**
   - テストが先にあることで、仕様が明確になる
   - テストカバレッジが自然に高くなる
   - バグの早期発見が可能

2. **リファクタリングの安全性**
   - テストがあるため、自信を持ってリファクタリングできる
   - 既存機能の破壊を防ぐセーフティネット
   - コードの改善を継続的に行える

3. **ドキュメントとしての機能**
   - テストコードが仕様書として機能
   - 使い方の実例を示す
   - コードの意図が明確になる

4. **設計の改善**
   - テスタブルなコードは、自然に良い設計になる
   - 依存関係が明確になる
   - 責務の分離が促進される

5. **学習効果**
   - テスト作成を通じて、仕様への理解が深まる
   - 良いテストの書き方を学べる
   - プロフェッショナルな開発手法の習得

## 結果

### ポジティブな影響

- **高いテストカバレッジ**
  - 全66テストケース、すべてグリーン
  - リクエストスペック、モデルスペックともに完全カバレッジ

- **安全なリファクタリング**
  - コードの改善を恐れずに実施できる
  - 既存機能の破壊を即座に検知できる

- **明確な仕様**
  - テストコードが仕様書として機能
  - 新しいメンバーが仕様を理解しやすい

- **バグの早期発見**
  - 実装前にテストを書くため、エッジケースを事前に考慮
  - 統合前にバグを発見・修正できる

- **自信を持った開発**
  - テストがあるため、変更に対する不安が少ない
  - Pull Request のレビューが容易

### ネガティブな影響

- **初期の開発速度**
  - テストを先に書くため、短期的には開発速度が遅くなる
  - 但し、長期的にはバグ修正コストが削減され、トータルでは速くなる

- **学習コスト**
  - TDDに不慣れなメンバーには学習が必要
  - 良いテストの書き方を習得するまで時間がかかる

- **テストメンテナンス**
  - テストコード自体のメンテナンスが必要
  - 仕様変更時にはテストも更新が必要

### 中立的な影響

- **コード量の増加**
  - テストコードが実装コードと同程度以上の量になる
  - 但し、ドキュメントとして機能するため価値がある

## 代替案

### 案1: 後からテストを書く（テストラスト）

**メリット**:
- 初期の開発速度が速い
- 実装に集中できる
- プロトタイピングに向いている

**デメリット**:
- テストカバレッジが低くなりがち
- テスト対象のコードがテスタブルでない場合がある
- バグの発見が遅れる

**却下理由**:
- 本プロジェクトは学習・実践を目的としており、品質を重視
- リファクタリングの安全性を確保したい
- 長期的な保守性を重視

### 案2: テストを書かない

**メリット**:
- 開発速度が最も速い
- テストメンテナンスコストがゼロ
- シンプルな開発プロセス

**デメリット**:
- バグの発見が遅れる
- リファクタリングが困難
- 仕様が不明確になりがち
- 変更に対する不安が大きい

**却下理由**:
- プロフェッショナルな開発手法として不適切
- 学習目的のプロジェクトとして価値が低い
- 長期的な保守が困難

### 案3: BDD（Behavior-Driven Development）

**メリット**:
- より自然言語に近い記述
- ビジネス要件との対応が明確
- ステークホルダーとのコミュニケーションツールとして機能

**デメリット**:
- 学習コストがTDDより高い
- ツール（Cucumber など）の習得が必要
- 小規模プロジェクトには過剰

**却下理由**:
- 本プロジェクトは小規模で、BDDのメリットが薄い
- TDDで十分な品質が確保できる
- シンプルさを重視

## 実装詳細

### 使用ツール

- **RSpec 7.1**: Railsのデファクトスタンダードなテストフレームワーク
- **FactoryBot**: テストデータの生成
- **Capybara**: システムテスト（将来的な追加を検討）

### テスト構成

```
spec/
├── requests/          # リクエストスペック（主要）
│   ├── admin/
│   │   ├── simple_transactions_spec.rb
│   │   └── api_call_logs_spec.rb
│   └── api/
│       └── v1/
│           └── simple_transactions_spec.rb
├── models/           # モデルスペック
│   ├── simple_transaction_spec.rb
│   ├── simple_transaction_item_spec.rb
│   └── api_call_log_spec.rb
└── factories/        # テストデータ定義
    ├── simple_transactions.rb
    ├── simple_transaction_items.rb
    └── api_call_logs.rb
```

### テスト実行

```bash
# 全テストの実行
bundle exec rspec

# 特定のテストの実行
bundle exec rspec spec/requests/admin/simple_transactions_spec.rb

# カバレッジレポート（将来的な追加）
# bundle exec rspec --format documentation
```

## 成果

### テストカバレッジ

- **総テスト数**: 66 examples
- **成功率**: 100% (66/66)
- **テストの種類**:
  - リクエストスペック: 60 examples
  - モデルスペック: 6 examples

### 具体例

```ruby
# spec/requests/admin/simple_transactions_spec.rb
RSpec.describe "Admin::SimpleTransactions", type: :request do
  describe "GET /admin/simple_transactions" do
    it "管理者画面の取引一覧が正常に表示されること" do
      get admin_simple_transactions_path
      expect(response).to have_http_status(:success)
    end

    it "全ての取引が表示されること" do
      get admin_simple_transactions_path
      expect(response.body).to include(transaction1.id.to_s)
      expect(response.body).to include(transaction2.id.to_s)
    end
  end
end
```

## 参考資料

- [RSpec 公式ドキュメント](https://rspec.info/)
- [Test Driven Development: By Example (Kent Beck)](https://www.amazon.com/Test-Driven-Development-Kent-Beck/dp/0321146530)
- [Rails Testing Guide](https://guides.rubyonrails.org/testing.html)

## 関連ADR

- なし

# ADR-001: PostgreSQL の採用

## ステータス

**承認済み** (2025-12-25)

## コンテキスト

SMDL簡易版ウェブアプリの開発にあたり、データベース管理システム（DBMS）を選定する必要があった。

### 要件

- Railsとの親和性が高いこと
- トランザクション処理が確実に行えること
- JSON型のサポート（将来的な拡張を考慮）
- 本番環境での実績があること
- 無料で利用できること

### 検討時の制約

- 開発・学習用プロジェクトのため、コストを抑える必要がある
- 既存のSMDLシステムとの整合性は考慮するが、完全な互換性は不要
- チームメンバーのスキルレベルに合わせた選定が必要

## 決定

**PostgreSQL 16** を採用する。

### 採用理由

1. **Rails との優れた統合**
   - ActiveRecord が PostgreSQL の機能を完全にサポート
   - マイグレーション機能が充実
   - パフォーマンスチューニングが容易

2. **データ型の豊富さ**
   - JSON/JSONB 型のサポート（API ログの保存に活用）
   - 配列型のサポート
   - カスタムデータ型の定義が可能

3. **トランザクション処理の信頼性**
   - ACID 特性の完全なサポート
   - 外部キー制約の完全なサポート
   - ロック機構が優れている

4. **スケーラビリティ**
   - 大規模データにも対応可能
   - レプリケーション機能（将来的な拡張に対応）
   - パーティショニング機能

5. **コスト**
   - 完全に無料のオープンソース
   - ライセンス料不要
   - 豊富なドキュメントとコミュニティサポート

## 結果

### ポジティブな影響

- **開発速度の向上**
  - Rails との統合が優れているため、スムーズな開発が可能
  - マイグレーション機能により、スキーマ変更が容易

- **データ整合性の保証**
  - 外部キー制約により、データの整合性を確保
  - トランザクション処理により、データの一貫性を保証

- **JSON 型の活用**
  - API ログの request_body, response_body を JSON 型で保存
  - 柔軟なクエリが可能

- **無料での利用**
  - 開発・本番環境ともにコスト0で運用可能

### ネガティブな影響

- **セットアップの複雑さ**
  - SQLite に比べて初期セットアップがやや複雑
  - PostgreSQL サーバーのインストールと設定が必要

- **リソース消費**
  - SQLite に比べてメモリ使用量が多い
  - バックグラウンドプロセスが常駐する

### 中立的な影響

- **学習コスト**
  - PostgreSQL 固有の機能を学ぶ必要がある
  - 但し、将来的なスキル向上につながる

## 代替案

### 案1: MySQL / MariaDB

**メリット**:
- Rails でのサポートが充実
- 広く使われており、情報が豊富
- パフォーマンスが良い

**デメリット**:
- JSON 型のサポートが PostgreSQL に劣る
- 外部キー制約のサポートが一部のストレージエンジンに限定
- ライセンス体系が複雑（MySQL は Oracle 所有）

**却下理由**:
- JSON 型の機能が PostgreSQL に劣る
- トランザクション処理の信頼性が PostgreSQL に劣る

### 案2: SQLite

**メリット**:
- セットアップが非常に簡単
- サーバー不要（ファイルベース）
- Rails のデフォルトデータベース

**デメリット**:
- 本番環境での利用には向かない
- 同時接続数の制限が厳しい
- 外部キー制約がデフォルトで無効

**却下理由**:
- 本番環境を想定した開発には不適切
- スケーラビリティに課題
- トランザクション処理の制限

### 案3: NoSQL (MongoDB など)

**メリット**:
- スキーマレスで柔軟なデータ構造
- スケーラビリティが高い
- JSON ネイティブのサポート

**デメリット**:
- Rails との統合が標準的ではない
- トランザクション処理が複雑
- リレーショナルデータモデルに向かない

**却下理由**:
- 本プロジェクトのデータ構造はリレーショナルモデルが最適
- Rails の ActiveRecord を最大限活用したい
- トランザクション処理の確実性が必要

## 参考資料

- [PostgreSQL 公式ドキュメント](https://www.postgresql.org/docs/)
- [Rails Guides: Active Record と PostgreSQL](https://guides.rubyonrails.org/active_record_postgresql.html)
- [データベース設計](../architecture/database.md)

## 関連ADR

- [ADR-004: ネストされた属性による一括保存](004-nested-attributes.md) - PostgreSQL のトランザクション処理を活用
